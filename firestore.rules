rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }

    function isHouseholdMember(householdId) {
      return isSignedIn() &&
             request.auth.uid in get(/databases/$(database)/documents/households/$(householdId)).data.members;
    }

    function isHouseholdCreator(householdId) {
      return isSignedIn() && 
             get(/databases/$(database)/documents/households/$(householdId)).data.createdBy == request.auth.uid;
    }

    // Users
    match /users/{uid} {
      allow read: if isOwner(uid) || isHouseholdMember(resource.data.householdId);
      allow write: if isOwner(uid) || isHouseholdMember(resource.data.householdId);
      allow create: if isSignedIn() && isHouseholdMember(request.resource.data.householdId);

      // Integration references (not raw tokens)
      match /integrations/{integration} {
        allow read, write: if isOwner(uid);
      }
    }

    // Households
    match /households/{householdId} {
      allow read: if isSignedIn() && (request.auth.uid in resource.data.members);
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (request.auth.uid in resource.data.members);
      allow delete: if isSignedIn() && isHouseholdCreator(householdId);
    }

    // Calendar events
    match /calendar-events/{eventId} {
      allow read, write: if isSignedIn();
    }

    // Photos
    match /photos/{photoId} {
      allow read: if isOwner(resource.data.ownerUid) || isHouseholdMember(resource.data.householdId);
      allow write: if isOwner(resource.data.ownerUid);
    }

    // Tasks
    match /tasks/{taskId} {
      allow read, write: if isSignedIn();
    }

    // Kudos
    match /kudos/{kudosId} {
      allow read: if isSignedIn() && isHouseholdMember(resource.data.householdId);
      allow write: if isSignedIn() && isHouseholdMember(resource.data.householdId);
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
